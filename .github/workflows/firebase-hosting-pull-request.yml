# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on PR
on: pull_request
permissions:
  checks: write
  contents: read
  pull-requests: write
jobs:
  build_and_preview:
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest
    env:
      IS_DEPENDABOT_PR: ${{ github.event.pull_request.user.login == 'dependabot[bot]' }}
    steps:
      - uses: actions/checkout@v4
      - name: Resolve Firebase API key
        id: firebase_api_key
        continue-on-error: ${{ env.IS_DEPENDABOT_PR == 'true' }}
        env:
          FIREBASE_WEB_API_KEY: ${{ secrets.FIREBASE_WEB_API_KEY }}
          PORTAL_FIREBASE_API_KEY: ${{ secrets.PORTAL_FIREBASE_API_KEY }}
        run: node ./scripts/resolve-firebase-api-key.mjs --github-output --json
      - name: Build web bundle with validated Firebase API key
        shell: bash
        env:
          IS_DEPENDABOT_PR: ${{ env.IS_DEPENDABOT_PR }}
          RESOLVED_FIREBASE_API_KEY: ${{ steps.firebase_api_key.outputs.firebase_api_key }}
          RESOLVED_FIREBASE_API_KEY_SOURCE: ${{ steps.firebase_api_key.outputs.firebase_api_key_source }}
        run: |
          set -euo pipefail

          selected_api_key="$RESOLVED_FIREBASE_API_KEY"
          selected_source="$RESOLVED_FIREBASE_API_KEY_SOURCE"

          if [ -z "$selected_api_key" ]; then
            if [ "$IS_DEPENDABOT_PR" = "true" ]; then
              selected_api_key="dependabot-ci-fallback-key"
              selected_source="dependabot-fallback"
              echo "Dependabot PR detected; using compile-only Firebase API key fallback."
            else
              echo "No valid Firebase web API key candidate resolved for web build." >&2
              exit 1
            fi
          fi

          echo "Using Firebase API key source: $selected_source"
          echo "VITE_FIREBASE_API_KEY=$selected_api_key" >> "$GITHUB_ENV"
          export VITE_FIREBASE_API_KEY="$selected_api_key"
          npm --prefix web ci
          npm --prefix web run build
      - name: Deploy preview channel
        if: ${{ env.IS_DEPENDABOT_PR != 'true' }}
        uses: FirebaseExtended/action-hosting-deploy@092436dca3ec6dacb231d965ae56f7ff6c09f258
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_MONSOONFIRE_PORTAL }}
          projectId: monsoonfire-portal

      - name: Skip preview deploy for Dependabot PRs
        if: ${{ env.IS_DEPENDABOT_PR == 'true' }}
        run: echo "Dependabot PR detected; skipping Firebase preview deploy step."
