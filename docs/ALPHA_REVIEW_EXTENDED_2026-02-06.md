# Alpha Readiness Extended Review (2026-02-06)

Scope: Web portal + Firebase Functions + static website.

This is an "eyes open" review aimed at alpha production readiness. It is intentionally biased toward release risk, operational verification, and "what can break when the branch is cut".

## Current risk posture (high signal)

### P0 - Evidence and drills are not complete
- `docs/RELEASE_CANDIDATE_EVIDENCE.md` still has unchecked items and placeholder counters/sign-off.
- Production drill execution has not been captured with real staff auth (prior attempts hit `UNAUTHENTICATED`).
- Closure path: Sprint 10 (`S10-01`, `S10-02`).

### P0 - Firebase Hosting deploy risk (placeholder `public/`) (resolved)
Previously `firebase.json` hosting output pointed at `public/` (default placeholder page).
- Fix applied: hosting now deploys `web/dist` and runs `npm --prefix web run build` as hosting `predeploy`.
- Residual: `public/index.html` placeholder remains in repo but is not deployed by Firebase Hosting.

### P0/P1 - Release branch hygiene is the biggest immediate practical risk
The worktree has a large set of modified files plus many untracked files that are required for CI/builds/docs.
- If the release branch is cut without staging the "??" files, CI and/or runtime will fail in confusing ways.
- Closure path: Sprint 10 (`S10-03`), plus explicitly stage the "required untracked" set below.

### P1 - macOS/iOS runtime gap
Windows cannot perform real iOS simulator/device runtime verification. CI has a macOS smoke workflow, but manual runtime validation is still required.
- Closure path: Sprint 10 (`S10-05`).

## Worktree observations

### Untracked files that are likely required for alpha
These are "??" in `git status` but appear necessary for CI/build/test/docs:
- CI/workflows: `.github/workflows/ci-smoke.yml`, `.github/workflows/lighthouse.yml`, `.github/workflows/ios-macos-smoke.yml`
- Web perf tooling: `web/scripts/check-chunk-budgets.mjs`, `web/lighthouserc.json`, `web/src/lib/perf/`, `web/src/lib/normalizers/`
- Web lint/test wiring: `web/tsconfig.eslint.json`, `web/src/views/*.test.ts`
- Web runtime helpers: `web/src/utils/toVoidHandler.ts`, `web/src/utils/handlerLog.ts`, `web/src/utils/userFacingErrors.ts`
- Portal staff/admin surfaces: `web/src/views/StaffView.tsx`, `web/src/views/NotificationsView.tsx`, `web/src/views/NotificationsView.css`
- Portal assets referenced by code: `web/public/branding/logo-mark-black.webp`, `web/src/assets/*.webp`
- Release ops docs used for alpha gate: `docs/NOTIFICATION_ONCALL_RUNBOOK.md`, `docs/DRILL_EXECUTION_LOG.md`, `docs/RELEASE_CANDIDATE_EVIDENCE.md`, `docs/SESSION_HANDOFF_2026-02-06.md`, `docs/SPRINT_MANAGER.md`
- Tickets/sprints tracking: `docs/sprints/`, `tickets/`

### Untracked files that are likely optional/non-alpha
- iOS reference app code in `ios/` (if alpha scope is web+functions only, this can be staged later, but do not lose it accidentally).
- `scripts/` (depends on which scripts are required for alpha ops).

### Local-only artifacts to keep out of release commits
- `firestore-debug.log`, `functions/firestore-debug.log` (staged for deletion from repo; ignored going forward)
- `.npm-cache/`, `.npm-cache-web/` (staged for deletion from repo; ignored going forward)
- `tmp-firebase.json` (untracked)
- `.lighthouseci/` (generated by Lighthouse CI)

## Web portal review notes

### Token handling and drill ergonomics
- `node ./scripts/ps1-run.mjs scripts/run-notification-drills.ps1` now validates `-IdToken` looks like a Firebase ID token (JWT issuer `https://securetoken.google.com/*`), strips accidental `Bearer `, and provides a concrete "where to get it" hint.
- `docs/NOTIFICATION_ONCALL_RUNBOOK.md` now documents token sourcing and warns not to paste real tokens into repo docs.

### PWA assets (resolved)
- Fix applied: `web/index.html` title set to `Monsoon Fire Portal` and favicon points at `/pwa-192.png`.
- Fix applied: `web/vite.config.js` PWA `includeAssets` no longer references a missing `favicon.ico`.

### Chunk budgets and build determinism
- `web/scripts/check-chunk-budgets.mjs` enforces size budgets against Vite output chunk name prefixes.
- This is effective but brittle if chunk names change (manualChunks changes, Vite output changes, or view filenames change).
- Recommendation: keep budgets but document the expected chunk naming contract in Sprint 11 (S11-02).

## Firebase Functions review notes

### Dev admin token is emulator-only (good)
`functions/src/shared.ts` gates the dev admin token flow behind:
- `ALLOW_DEV_ADMIN_TOKEN=true`
- `FUNCTIONS_EMULATOR=true`
This prevents accidental prod enablement if `ADMIN_TOKEN` is set somewhere.

### Durable rate limits exist, but Firestore growth is unbounded
`functions/src/shared.ts` writes per key/uid/ip docs to `rateLimits/{bucketKey}`.
- Fix applied: durable docs now include `expiresAt` to support Firestore TTL cleanup.
- Follow-up (manual): enable Firestore TTL on `rateLimits.expiresAt` in the console.

## Firestore rules review notes

### Editors vs batch document reads (potential product gap)
`match /batches/{batchId}` read is limited to staff or owner only, while many sub-reads use `canReadBatch(batchId)` which allows editors.
- Decision recorded: keep as-is for alpha (no editors-based collaboration model in the portal yet).

## Static website review notes

### CSP and JSON-LD maintainability (resolved)
Previously multiple pages contained inline JSON-LD and CSP included a `script-src` hash.
- Fix applied: JSON-LD is now loaded from `website/assets/schema/localbusiness.json` via `src=...`, and the hash was removed from CSP.

### Cache headers vs non-fingerprinted assets (resolved)
Previously `website/web.config` applied a 365-day cache TTL to everything under `/assets` (including non-fingerprinted CSS/JS).
- Fix applied: `/assets` now uses a short TTL (1 hour) and `/assets/images` keeps a long TTL (365 days).
- Follow-up: if you want long-lived CSS/JS caching, introduce fingerprinted asset filenames for CSS/JS.

## CI/automation review notes

### Node version parity
GitHub workflows were pinned to Node 20; web and functions are already on modern versions.
- Fix applied: CI workflows now use Node 22 for parity with functions runtime and current tooling.

### Missing CI checks (resolved)
Previously the smoke workflow did not run `npm --prefix functions run lint`.
- Fix applied: smoke workflow now includes `Functions lint` (warnings remain non-blocking).

## Recommended next actions (priority order)
1. Close Sprint 10 alpha gate items (`S10-01`..`S10-04`), then fill `docs/RELEASE_CANDIDATE_EVIDENCE.md`.
2. Cut a release branch only after staging all required "??" files and excluding local artifacts.
3. Run iOS runtime validation on macOS (manual) plus confirm `iOS macOS Smoke` workflow artifacts.
4. Execute Sprint 11 perf/testing (budgets, tests, lint debt, cold-start pass).
