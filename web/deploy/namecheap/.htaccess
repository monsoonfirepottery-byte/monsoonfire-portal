<IfModule mod_rewrite.c>
  RewriteEngine On

  # Compatibility fallback: some shared hosts do not serve dot-prefixed folders directly.
  RewriteRule ^\.well-known/(.+)$ well-known/$1 [L,NC]

  # Never rewrite well-known association files (universal links, etc).
  RewriteRule ^well-known/ - [L]

  # Cache policy hints for static assets and root compatibility chunks.
  RewriteRule ^assets/ - [L,E=MF_ASSET_CACHE:1]
  RewriteRule ^[^/]+\.(js|css|map)$ - [E=ROOT_COMPAT_CHUNK:1]

  # Never rewrite service worker/runtime manifest endpoints.
  RewriteRule ^(registerSW\.js|sw\.js|workbox-.*\.js|manifest\.webmanifest)$ - [L]

  # Never rewrite static file extension requests. Missing files should return 404.
  RewriteRule \.(js|css|map|json|txt|xml|png|jpg|jpeg|gif|svg|webp|ico|woff2?)$ - [L,NC]

  # Keep app shell HTML fresh for root and deep-link routes.
  RewriteRule ^index\.html$ - [E=MF_HTML_CACHE:1]
  RewriteRule ^$ index.html [L,E=MF_HTML_CACHE:1]

  # SPA fallback: if it's not a real file or directory, serve index.html
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule ^ index.html [L,E=MF_HTML_CACHE:1]
</IfModule>


<IfModule mod_headers.c>
  Header set Cache-Control "public, max-age=31536000, immutable" env=MF_ASSET_CACHE

  # Root-level compatibility chunks should never be cached.
  Header set Cache-Control "no-store, max-age=0" env=ROOT_COMPAT_CHUNK

  Header set Cache-Control "no-cache" env=MF_HTML_CACHE
</IfModule>
