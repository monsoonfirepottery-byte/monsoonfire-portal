<IfModule mod_rewrite.c>
  RewriteEngine On

  # Never rewrite well-known association files (universal links, etc).
  RewriteRule ^\.well-known/ - [L]

  # Never rewrite hashed asset requests. Missing files should 404, not return index.html.
  RewriteRule ^assets/ - [L]

  # Never rewrite service worker/runtime manifest endpoints.
  RewriteRule ^(registerSW\.js|sw\.js|workbox-.*\.js|manifest\.webmanifest)$ - [L]

  # Never rewrite static file extension requests. Missing files should return 404.
  RewriteRule \.(js|css|map|json|txt|xml|png|jpg|jpeg|gif|svg|webp|ico|woff2?)$ - [L,NC]

  # Mark root-level compatibility chunks (legacy module URLs) for no-store caching.
  RewriteRule ^[^/]+\.(js|css|map)$ - [E=ROOT_COMPAT_CHUNK:1]

  # SPA fallback: if it's not a real file or directory, serve index.html
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule ^ index.html [L]
</IfModule>


<IfModule mod_headers.c>
  # Vite build output is content-hashed under /assets. Cache aggressively.
  <FilesMatch "^assets/.*\\.(js|css|map|png|jpg|jpeg|gif|svg|webp|ico|woff2?)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  # Root-level compatibility chunks should never be cached.
  Header set Cache-Control "no-store, max-age=0" env=ROOT_COMPAT_CHUNK

  # Keep HTML fresh to pick up new deployments quickly.
  <FilesMatch "^index\\.html$">
    Header set Cache-Control "no-cache"
  </FilesMatch>
</IfModule>
